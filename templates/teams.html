{% extends "base.html" %}
{% block content %}
<!--
  Modern/custom teams page (Option B)
  - Responsive grid (auto-fill)
  - Search, filter, sort, modal quick view
  - Pastel variants (6)
  - Avatar = 60% of card width (circle)
-->
<style>
:root{
  --card-radius: 14px;
  --card-padding: 22px;
  --card-shadow: 0 10px 28px rgba(2,6,23,0.12);
  --card-shadow-hover: 0 18px 48px rgba(2,6,23,0.18);
  --muted: #6b7280;
  --accent: #0ea5a9;
}

/* Layout */
.teams-top {
  display:flex;
  gap:12px;
  align-items:center;
  justify-content:space-between;
  margin-bottom:18px;
}
.controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.control-input { padding:8px 12px; border-radius:8px; border:1px solid #e6e8eb; background:#fff; font-size:14px; }

/* Grid - modern responsive */
.grid {
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap:22px;
}

/* Card base */
.card {
  background: #fff;
  border-radius: var(--card-radius);
  padding: var(--card-padding);
  box-shadow: var(--card-shadow);
  display:flex;
  flex-direction:column;
  align-items:center;
  position:relative;
  transition: transform .14s ease, box-shadow .14s ease;
  min-height:360px;
}
.card:focus-within, .card:hover { transform: translateY(-8px); box-shadow: var(--card-shadow-hover); outline: none; }

/* Pastel variants (6) */
.card.variant-0 { background: linear-gradient(180deg,#f0fff4, #eafbea); }
.card.variant-1 { background: linear-gradient(180deg,#fff1f3, #fff0f2); }
.card.variant-2 { background: linear-gradient(180deg,#f1f5ff, #eef4ff); }
.card.variant-3 { background: linear-gradient(180deg,#fffbeb, #fff7d9); }
.card.variant-4 { background: linear-gradient(180deg,#f6f0ff, #f1ebff); }
.card.variant-5 { background: linear-gradient(180deg,#fff7f0, #fff2e8); }

/* Avatar: 60% of card width */
.avatar {
  width:60%;
  aspect-ratio:1/1;
  border-radius:50%;
  overflow:hidden;
  border:6px solid rgba(0,0,0,0.06);
  box-shadow: 0 10px 22px rgba(2,6,23,0.12);
  margin-top:-38px;
  background:#e6e6e6;
  display:flex;
  align-items:center;
  justify-content:center;
}
.avatar img { width:100%; height:100%; object-fit:cover; display:block; }

/* Name / role */
.name { margin-top:12px; font-weight:800; font-size:18px; color:#0f1724; text-align:center; }
.role { font-size:13px; color:var(--muted); margin-bottom:6px; text-transform:capitalize; }

/* meta info */
.meta { margin-top:6px; color:#334155; font-size:13px; text-align:center; }
.meta .line { margin-top:6px; display:flex; gap:8px; align-items:center; justify-content:center; color:#475569; }
.contact { margin-top:12px; color:#0f1724; font-size:13px; display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; }

/* disabled badge */
.badge-disabled {
  position:absolute; right:12px; top:12px;
  background: rgba(17,24,39,0.95); color:#fff; padding:6px 8px; border-radius:8px; font-size:12px;
}

/* top controls styling */
.search { min-width:260px; }
select.control-input { min-width:150px; }
.small-note { color:var(--muted); font-size:13px; margin-left:8px; }

/* modal */
.modal-backdrop {
  position:fixed; inset:0; background:rgba(2,6,23,0.5); display:flex; align-items:center; justify-content:center; z-index:1100;
}
.modal-card {
  background:#fff; border-radius:12px; padding:18px; width:92%; max-width:720px; box-shadow: 0 20px 60px rgba(2,6,23,0.35);
}

/* toast */
.toast {
  position:fixed; right:18px; top:18px; z-index:1200; background:#0f1724; color:#fff; padding:10px 14px; border-radius:8px; box-shadow:0 6px 20px rgba(2,6,23,0.25);
}

/* accessibility focus */
.card:focus-within, button:focus, a:focus, .control-input:focus { outline: 3px solid rgba(14,165,169,0.12); outline-offset:2px; }

/* responsive tweaks */
@media (max-width:820px){ .avatar { width:64%; } }
@media (max-width:520px){ .teams-top { flex-direction:column; align-items:flex-start; gap:10px; } }
</style>

<div class="teams-top">
  <div>
    <h2 style="margin:0 0 6px 0;">All members</h2>
    
  </div>

  <div class="controls">
    <input id="searchInput" class="control-input search" placeholder="Search by name or email..." aria-label="Search team members">
    <select id="roleFilter" class="control-input" aria-label="Filter by role">
      <option value="">All roles</option>
      <option value="admin">Admin</option>
      <option value="recruiter">Recruiter</option>
      <option value="employee">Employee</option>
    </select>
    <select id="sortBy" class="control-input" aria-label="Sort by">
      <option value="name_asc">Name ‚Üë</option>
      <option value="name_desc">Name ‚Üì</option>
      <option value="joined_new">Joined (new)</option>
      <option value="joined_old">Joined (old)</option>
    </select>

    {% if role == 'admin' %}
      <a class="btn btn-sm" style="display:inline-block; padding:8px 12px; background:var(--accent); color:#fff; border-radius:8px; text-decoration:none" href="{{ url_for('myteam.admin_teams') }}">Open Admin</a>
    {% endif %}

    <a class="btn btn-sm" style="display:inline-block; padding:8px 12px; background:#111827; color:#fff; border-radius:8px; text-decoration:none" href="{{ url_for('myteam.teams', show_all=('0' if show_all else '1')) }}">{{ 'Hide disabled' if show_all else 'Show all' }}</a>
  </div>
</div>

<div class="grid" id="cardsGrid" role="list">
  {# Each card uses variant by loop index to vary background #}
  {% for m in members %}
  <article class="card variant-{{ loop.index0 % 6 }}" role="listitem" tabindex="0" data-name="{{ m.name|lower }}" data-email="{{ (m.email or '')|lower }}" data-role="{{ (m.designation or '')|lower }}" data-joined="{{ (m.joining_date.isoformat() if m.joining_date else '') }}">
    {% if not m.is_active %}
      <div class="badge-disabled">Disabled</div>
    {% endif %}

    <div class="avatar" aria-hidden="true">
      {% if m.image_url %}
        <img src="{{ get_image_url(m.image_url) }}" alt="{{ m.name }}" loading="lazy">
      {% else %}
        <div style="font-size:36px; font-weight:700; color:#0f1724;">{{ (m.name.split(' ')[0] if m.name else '')[:1] }}</div>
      {% endif %}
    </div>

    <div class="name">{{ m.name }}</div>
    <div class="role">{{ m.designation or 'Member' }}</div>

    <div class="meta">
      <div class="line">üìÖ <strong>Joined:</strong> {{ m.joining_date|fmtdate }}</div>
      <div class="line">üéÇ <strong>Birthday:</strong> {{ m.birthday|fmtdate }}</div>
      <div class="line">üíç <strong>Anniversary:</strong> {{ m.anniversary|fmtdate }}</div>
    </div>

    <div class="contact" aria-label="contact">
      {% if m.email %} <span title="Email">üìß {{ m.email }}</span> {% endif %}
      {% if m.phone_number %} <span title="Phone">üìû {{ m.phone_number }}</span> {% endif %}
      
    </div>
  </article>
  {% else %}
    <div style="color:var(--muted); padding:22px;">No members found.</div>
  {% endfor %}
</div>

<!-- Modal (hidden by default) -->
<div id="modalBackdrop" class="modal-backdrop" style="display:none;" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-card" id="modalCard" tabindex="0">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 id="modalName">Member</h3>
      <button onclick="closeQuickView()" aria-label="Close" style="background:none;border:none;font-size:18px;cursor:pointer;">‚úï</button>
    </div>
    <div id="modalBody" style="margin-top:12px; display:flex; gap:16px; align-items:flex-start;">
      <!-- left: avatar -->
      <div style="min-width:160px; flex:0 0 160px;">
        <div style="width:160px; height:160px; border-radius:50%; overflow:hidden; box-shadow:0 10px 24px rgba(2,6,23,0.12);" id="modalAvatar">
        </div>
      </div>
      <div style="flex:1;">
        <div id="modalRole" style="color:var(--muted); margin-bottom:8px;"></div>
        <div id="modalJoined" class="meta"></div>
        <div id="modalBirthday" class="meta"></div>
        <div id="modalAnniv" class="meta"></div>
        <div id="modalContact" style="margin-top:12px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Toast container -->
<div id="toast" style="display:none;" class="toast" role="status" aria-live="polite"></div>

<script>
/* ====== Client-side search/filter/sort + modal logic ====== */
(() => {
  const searchInput = document.getElementById('searchInput');
  const roleFilter = document.getElementById('roleFilter');
  const sortBy = document.getElementById('sortBy');
  const cardsGrid = document.getElementById('cardsGrid');
  const cards = Array.from(cardsGrid.querySelectorAll('.card'));

  function normalize(s){ return (s||'').toString().toLowerCase().trim(); }

  function applyFilterSort(){
    const q = normalize(searchInput.value);
    const role = normalize(roleFilter.value);
    const sort = sortBy.value;

    let visible = cards.filter(card => {
      const name = card.dataset.name || '';
      const email = card.dataset.email || '';
      const crow = card.dataset.role || '';
      const matchQ = !q || name.includes(q) || email.includes(q);
      const matchRole = !role || crow.includes(role);
      return matchQ && matchRole;
    });

    // sort
    visible.sort((a,b) => {
      if(sort === 'name_asc') return a.dataset.name.localeCompare(b.dataset.name);
      if(sort === 'name_desc') return b.dataset.name.localeCompare(a.dataset.name);
      if(sort === 'joined_new') return (b.dataset.joined || '').localeCompare(a.dataset.joined || '');
      if(sort === 'joined_old') return (a.dataset.joined || '').localeCompare(b.dataset.joined || '');
      return 0;
    });

    // append visible in order and hide others
    cards.forEach(c => { c.style.display = 'none'; });
    visible.forEach(c => { c.style.display = ''; cardsGrid.appendChild(c); });
  }

  searchInput.addEventListener('input', applyFilterSort);
  roleFilter.addEventListener('change', applyFilterSort);
  sortBy.addEventListener('change', applyFilterSort);

  // small debounce to avoid lag on large lists
  let deb;
  searchInput.addEventListener('input', () => { clearTimeout(deb); deb = setTimeout(applyFilterSort, 150); });

  // initial apply
  applyFilterSort();

  // Modal support: fetch detail from server endpoint or use preloaded data.
  // We'll try to fetch /myteam/api/teams/<id> (blueprint route included earlier in myteam.py)
  window.openQuickView = async function(id){
    const backdrop = document.getElementById('modalBackdrop');
    const modalName = document.getElementById('modalName');
    const modalAvatar = document.getElementById('modalAvatar');
    const modalRole = document.getElementById('modalRole');
    const modalJoined = document.getElementById('modalJoined');
    const modalBirthday = document.getElementById('modalBirthday');
    const modalAnniv = document.getElementById('modalAnniv');
    const modalContact = document.getElementById('modalContact');

    // show loading skeleton
    modalName.textContent = 'Loading...';
    modalAvatar.innerHTML = '<div style="width:100%;height:100%;background:#f3f4f6;"></div>';
    modalRole.textContent = '';
    modalJoined.textContent = '';
    modalBirthday.textContent = '';
    modalAnniv.textContent = '';
    modalContact.textContent = '';

    backdrop.style.display = 'flex';
    backdrop.setAttribute('aria-hidden','false');

    try {
      const resp = await fetch(`{{ url_for('myteam.api_update_member', member_id=0) }}`.replace('/0', '/' + id));
      // if the API uses GET, adjust - but my earlier blueprint used GET via query; else use endpoint below
      if(!resp.ok){
        // fallback: get DOM card and read content
        const card = document.querySelector('.card[data-id="'+id+'"]') || null;
        // read from page: find the article where innerHTML contains the id (we didn't store id attr originally)
        // Instead just try a simple approach: look for article with matching id via loop
      }
      const data = await resp.json();
      // populate
      modalName.textContent = data.name || 'Member';
      modalRole.textContent = data.designation || '';
      modalJoined.innerHTML = 'üìÖ <strong>Joined:</strong> ' + (data.joining_date || '');
      modalBirthday.innerHTML = 'üéÇ <strong>Birthday:</strong> ' + (data.birthday || '');
      modalAnniv.innerHTML = 'üíç <strong>Anniversary:</strong> ' + (data.anniversary || '');
      let contactHtml = '';
      if(data.email) contactHtml += 'üìß ' + data.email;
      if(data.phone_number) contactHtml += ' &nbsp; ‚Ä¢ &nbsp; üìû ' + (data.phone_number || '');
      modalContact.innerHTML = contactHtml || '<span style="color:var(--muted)">No contact info</span>';
      if(data.image_url){
        modalAvatar.innerHTML = `<img src="${data.image_url.startsWith('http') ? data.image_url : ('/static/uploads/'+data.image_url)}" alt="${data.name}" style="width:100%;height:100%;object-fit:cover;">`;
      } else {
        modalAvatar.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-weight:700;">${(data.name||'')[0]||'?'}</div>`;
      }
    } catch (err) {
      // If fetch fails, read from DOM card - search by visible name
      const maybe = Array.from(document.querySelectorAll('.card')).find(c=>c.querySelector('.name') && c.querySelector('.name').textContent.trim().startsWith(''));
      modalName.textContent = 'Member details';
      modalRole.textContent = '';
      modalJoined.textContent = '';
      modalContact.textContent = '';
    }
  };

  window.closeQuickView = function(){
    const backdrop = document.getElementById('modalBackdrop');
    backdrop.style.display = 'none';
    backdrop.setAttribute('aria-hidden','true');
  };

  // close modal on ESC
  document.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeQuickView(); });

  // Toast helper
  window.showToast = function(msg, duration=3000){
    const t = document.getElementById('toast');
    t.textContent = msg; t.style.display = 'block';
    setTimeout(()=>{ t.style.opacity = '1'; }, 20);
    setTimeout(()=>{ t.style.opacity = '0'; setTimeout(()=>t.style.display='none',300); }, duration);
  };

})();
</script>

{% endblock %}
