{% extends "base.html" %}
{% block content %}
<div class="rfu-page">

  <style>
  :root {
    --bg:#f6f9fb;
    --card:#ffffff;
    --text:#1e293b;
    --muted:#64748b;
    --primary:#1676ff;
    --stroke:#e5e7eb;
    --table-head:#0f172a;
    --table-head-text:#fff;
    --row-hover:#f1f5f9;
    --btn:#1676ff;
    --btn-text:#fff;
    --shadow:0 4px 16px rgba(2,8,23,.06);
    --radius:12px;
  }

  body { background: var(--bg); }
.rfu-page .container {
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 16px 20px;
  }

  h2.fw-bold {
    font-size: 20px;
    font-weight: 700;
    margin: 0;
    color: var(--text);
  }

  .btn {
    border-radius: 10px !important;
    font-weight: 600;
    padding: 8px 14px;
    box-shadow: 0 1px 2px rgba(0,0,0,.08);
  }
  .btn-darkgreen {
    background: #0bb7a7;
    border: none;
  }
  .btn-darkgreen:hover { background: #099487; }
  .btn-darkblue {
    background: var(--primary);
    border: none;
  }
  .btn-darkblue:hover { background: #0b56c5; }

  .form-select, .form-control {
    border-radius: 10px;
    border: 1px solid var(--stroke);
    box-shadow: none !important;
    font-size: 14px;
  }

  .table {
    border-radius: var(--radius);
    overflow: hidden;
    border: 1px solid var(--stroke);
  }
  .table thead th {
    background: var(--table-head);
    color: var(--table-head-text);
    font-size: 13px;
    font-weight: 600;
    border: none !important;
  }
  .table tbody td {
    background: #fff;
    font-size: 14px;
    border-top: 1px solid var(--stroke);
  }
  .table tbody tr:hover td {
    background: var(--row-hover);
  }
  </style>


<div class="container py-2">
  <div class="d-flex justify-content-between align-items-center mb-1">
    <h2 class="fw-bold">Active Requirements</h2>
    <a href="{{ url_for('add_requirement') }}" class="btn btn-darkgreen" style="margin-bottom:10px;">
      <i class="bi bi-plus-lg"></i> Add New Requirement
    </a>
  </div>

  <!-- Filters -->
  <form id="filterForm" class="row g-2 mb-3 align-items-center" method="get" role="search" aria-label="Filter requirements">
    <div class="col-md-2">
      <select class="form-select" name="status" aria-label="Filter by status">
        <option value="">All status</option>
        <option value="Active" {% if status_filter == 'Active' %}selected{% endif %}>Active</option>
        <option value="Hold" {% if status_filter == 'Hold' %}selected{% endif %}>Hold</option>
        <option value="Closed" {% if status_filter == 'Closed' %}selected{% endif %}>Closed</option>
      </select>
    </div>

    <div class="col-md-2">
      <input type="search" name="client" class="form-control" placeholder="Search by client" value="{{ client_filter }}">
    </div>

    <div class="col-md-2">
      <input type="search" name="requirement" class="form-control" placeholder="Search by requirement" value="{{ requirement_filter }}">
    </div>

    <div class="col-md-4 d-flex gap-2">
      <input type="search" name="assigned_to" class="form-control" placeholder="Search by assigned" value="{{ assigned_filter }}">
      <button class="btn btn-darkblue" type="submit">Apply</button>
      <a class="btn btn-darkblue" href="{{ url_for('requirements') }}">Reset</a>
    </div>
  </form>

  <!-- Active filter chips -->
  <div class="mb-3">
    {% if client_filter %}
      <span class="badge bg-secondary filter-chip">
        Client: {{ client_filter }}
        <a href="{{ url_for('requirements', client=None, requirement=requirement_filter or None, status=status_filter or None, assigned_to=assigned_filter or None) }}">&times;</a>
      </span>
    {% endif %}
    {% if requirement_filter %}
      <span class="badge bg-secondary filter-chip">
        Requirement: {{ requirement_filter }}
        <a href="{{ url_for('requirements', client=client_filter or None, requirement=None, status=status_filter or None, assigned_to=assigned_filter or None) }}">&times;</a>
      </span>
    {% endif %}
    {% if status_filter %}
      <span class="badge bg-secondary filter-chip">
        Status: {{ status_filter }}
        <a href="{{ url_for('requirements', client=client_filter or None, requirement=requirement_filter or None, status=None, assigned_to=assigned_filter or None) }}">&times;</a>
      </span>
    {% endif %}
    {% if assigned_filter %}
      <span class="badge bg-secondary filter-chip">
        Assigned: {{ assigned_filter }}
        <a href="{{ url_for('requirements', client=client_filter or None, requirement=requirement_filter or None, status=status_filter or None, assigned_to=None) }}">&times;</a>
      </span>
    {% endif %}

    {% if client_filter or requirement_filter or status_filter or assigned_filter %}
      <a href="{{ url_for('requirements') }}" class="ms-2">Clear All</a>
    {% endif %}
  </div>

  <div class="table-responsive">
    <table class="table table-hover align-middle table-bordered">
      <thead class="table-light">
        <tr>
          <th data-sort="added_date">Added Date</th>
          <th data-sort="client_name">Client</th>
          <th data-sort="requirement_name">Requirement</th>
          <th data-sort="experience">Experience</th>
          <th>Locations</th>
          <th>Remote</th>
          <th data-sort="budget">Budget</th>
          <th class="skills-col">Skills</th>
          <th data-sort="assigned_to">Assigned To</th>
          <th>Candidates</th>
          <th data-sort="status">Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for req in requirements %}
        <tr id="req-row-{{ req.id }}">
          <td>{{ req.added_date.strftime('%Y-%m-%d') if req.added_date else 'Not recorded' }}</td>
          <td>{{ req.client_name }}</td>
          <td>{{ req.requirement_name }}</td>
          <td>{{ req.experience }}</td>
          <td>{{ req.job_locations }}</td>
          <td>{{ 'Yes' if req.remote else 'No' }}</td>
          <td>{{ req.budget }}</td>
          <td class="skills-col">
            {% set skills = req.mandatory_skills or '' %}
            {{ skills[:30] }}{% if skills|length > 30 %}...{% endif %}
          </td>
          <td>{{ req.assigned_to or '' }}</td>
          <td class="center-btn">
            <a href="/requirement/{{ req.id }}/candidates" 
               class="btn btn-sm btn-darkblue" 
               title="View Candidates">
              <i class="bi bi-people"></i>
            </a>
          </td>
          <td>
            <span class="badge {% if req.status == 'Active' %}bg-success{% elif req.status == 'Hold' %}bg-warning text-dark{% else %}bg-secondary{% endif %}" style="font-size:0.75rem;">
              {{ req.status }}
            </span>
          </td>
          <td class="center-btn">
            <div class="d-flex gap-2 justify-content-center">
              <button class="btn btn-sm btn-darkblue" data-bs-toggle="modal"
                      data-bs-target="#detailModal{{ req.id }}" aria-label="View requirement details">
                <i class="bi bi-eye"></i>
              </button>
              <a href="{{ url_for('update_requirement', req_id=req.id) }}"
                 class="btn btn-sm btn-darkblue" aria-label="Edit requirement">
                <i class="bi bi-pencil"></i>
              </a>
              <form method="POST" action="{{ url_for('delete_requirement', req_id=req.id) }}" onsubmit="return confirm('Delete this requirement?');" style="display:inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-sm btn-danger" aria-label="Delete requirement">
                  <i class="bi bi-trash"></i>
                </button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if total %}
    <div class="small text-muted mt-2">
      Showing page {{ page }} â€” total results: {{ total }}
    </div>
  {% endif %}
</div>

<!-- Modals -->
{% for req in requirements %}
<div class="modal fade" id="detailModal{{ req.id }}" tabindex="-1" aria-labelledby="detailModalLabel{{ req.id }}" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailModalLabel{{ req.id }}">Requirement Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" aria-live="polite">
        <div class="text-center py-4">Loading...</div>
      </div>
    </div>
  </div>
</div>
{% endfor %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // AJAX load partial into modal
    document.querySelectorAll('.modal').forEach(function(modal) {
      modal.addEventListener('show.bs.modal', function() {
        var reqId = modal.id.replace('detailModal','');
        fetch('/requirement_detail/' + reqId, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
          .then(r => { if (!r.ok) throw new Error('Network'); return r.text(); })
          .then(html => { modal.querySelector('.modal-body').innerHTML = html; })
          .catch(() => { modal.querySelector('.modal-body').innerHTML = '<div class="text-danger">Error loading details</div>'; });
      });
    });

    // Click-to-sort on headers
    document.querySelectorAll('th[data-sort]').forEach(function(th) {
      th.addEventListener('click', function() {
        var sortBy = th.getAttribute('data-sort');
        var url = new URL(window.location.href);
        var params = url.searchParams;
        var current = params.get('sort_by') || 'added_date';
        var dir = (params.get('sort_dir') || 'desc').toLowerCase();
        if (current === sortBy) dir = (dir === 'desc') ? 'asc' : 'desc';
        else dir = 'desc';
        params.set('sort_by', sortBy);
        params.set('sort_dir', dir);
        url.search = params.toString();
        window.location = url.toString();
      });
    });
  });
</script>
</div>
{% endblock %}
{% endblock %}
