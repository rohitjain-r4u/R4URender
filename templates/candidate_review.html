{% extends "base.html" %}
{% block content %}
<div class="container-fluid py-4">
  <h3 class="mb-4">Candidate Review</h3>

  <!-- Summary -->
  <div class="alert alert-info">
    <strong>Total Rows:</strong> {{ rows|length }} |
    <strong>Total Columns:</strong> {{ columns|length }}
  </div>

  <!-- Review Table -->
  <div class="table-responsive" style="max-height:70vh; overflow-y:auto; overflow-x:auto;">
    <table class="table table-bordered table-sm align-middle review-table">
      <thead class="table-light">
        <tr>
          {% for col in columns %}
            <th>{{ col }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        <tr class="{{ 'table-success' if row.valid else 'table-danger' }}">
          {% for col in columns %}
            {% set val = row.data[col] %}
            <td contenteditable="true" data-col="{{ col }}">
              {{ '' if val is none or val|string == 'nan' else val }}
            </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Actions -->
  <div class="mt-3">
    <form id="finalizeForm"
          method="post"
          action="/candidates/import/commit"
          onsubmit="submitFinalize(event)">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="upload_id" value="{{ upload_id }}">
      <textarea name="edited_data" id="edited_data" hidden></textarea>
      <input type="hidden" name="mapping" id="mapping" />
      <input type="hidden" name="requirement_id" value="{{ req_id or session.get('requirement_id') or '' }}">
      <button type="submit" id="finalizeBtn" class="btn btn-success">
        Finalize Import
      </button>
      <!-- Send JD removed as requested -->
    </form>
  </div>
</div>

<!-- üîÑ Processing Overlay (hidden by default) -->
<div id="processingOverlay" style="
  display:none;
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.45);
  z-index:2000;
  text-align:center;
  color:#fff;
  font-size:1.15rem;
  font-weight:600;
  padding-top:18vh;
">
  <div class="d-inline-block bg-transparent p-4 rounded" style="backdrop-filter: blur(2px);">
    <div class="spinner-border text-light" role="status" style="width:3rem; height:3rem;"></div>
    <div class="mt-3">Processing import‚Ä¶ please wait</div>
  </div>
</div>

<style>
  .review-table th {
    position: sticky;
    top: 0;
    background-color: #f8f9fa !important;
    z-index: 2;
  }
  .review-table th,
  .review-table td {
    border: 1px solid #000 !important;
    height: 35px !important;
    min-width: 120px !important;
    max-width: 160px !important;
    padding: 4px 6px !important;
    vertical-align: middle !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
  }
</style>

<script>
// 1) Load mapping that was saved on the mapping screen
//    (it's an array of {uploaded, matched, status} objects)
window.mapping = JSON.parse(localStorage.getItem('candidateMapping') || '[]');

// 2) Collect table edits into an array of row objects
function collectEdits() {
  const rows = [];
  document.querySelectorAll("tbody tr").forEach((tr) => {
    const rowData = {};
    tr.querySelectorAll("td[data-col]").forEach(td => {
      const col = td.getAttribute("data-col");
      rowData[col] = td.innerText.trim();
    });
    rows.push(rowData);
  });
  document.getElementById("edited_data").value = JSON.stringify(rows);

  // Attach mapping (array is fine; backend converts to dict)
  document.getElementById("mapping").value = JSON.stringify(window.mapping);

  // Ensure requirement_id is populated:
  const urlParams = new URLSearchParams(window.location.search);
  const fromUrl = urlParams.get('req_id') || urlParams.get('requirement_id');
  const hidden = (document.querySelector('input[name="requirement_id"]') || {}).value || '';
  const finalReq = (fromUrl && fromUrl !== 'None') ? fromUrl : (hidden && hidden !== 'None' ? hidden : (localStorage.getItem('requirement_id') || ''));
  const reqInput = document.querySelector('input[name="requirement_id"]');
  if (reqInput) reqInput.value = finalReq;
  if (finalReq) localStorage.setItem('requirement_id', finalReq);
}

// 3) Submit via fetch as FormData (matches backend expecting request.form)
async function submitFinalize(event) {
  event.preventDefault();
  collectEdits();

  const overlay = document.getElementById("processingOverlay");
  const finalizeBtn = document.getElementById("finalizeBtn");

  // Show overlay and disable button to prevent duplicate submits
  overlay.style.display = "block";
  if (finalizeBtn) {
    finalizeBtn.disabled = true;
    finalizeBtn.classList.add('disabled');
    finalizeBtn.setAttribute('aria-disabled', 'true');
  }

  const form = document.getElementById("finalizeForm");
  const formData = new FormData(form);

  try {
    const resp = await fetch(form.action, { method: "POST", body: formData });
    let result = {};
    try {
      result = await resp.json();
    } catch (e) {
      // non-json response
      result = {};
    }

    if (resp.ok && result.status === "ok") {
      // show success toast/alert then redirect
      alert("‚úÖ Candidates imported successfully (" + (result.rows_inserted || 0) + " rows).");

      // Redirect using requirement_id actually submitted
      const reqId = (form.querySelector('input[name="requirement_id"]') || {}).value || '';
      if (reqId) {
        window.location.href = `/requirement/${reqId}/candidates`;
      } else {
        window.location.href = `/`;
      }
    } else {
      // Show meaningful error and re-enable for retry
      const errMsg = result.message || ("Import failed. Server returned status " + resp.status);
      alert("‚ùå Import failed: " + errMsg);
      // Re-enable if failed so user can retry after fixing issues
      if (finalizeBtn) {
        finalizeBtn.disabled = false;
        finalizeBtn.classList.remove('disabled');
        finalizeBtn.removeAttribute('aria-disabled');
      }
    }
  } catch (err) {
    alert("‚ùå Import failed due to server error: " + (err && err.message ? err.message : err));
    if (finalizeBtn) {
      finalizeBtn.disabled = false;
      finalizeBtn.classList.remove('disabled');
      finalizeBtn.removeAttribute('aria-disabled');
    }
  } finally {
    // Hide overlay when done (if successful we are redirecting anyway)
    overlay.style.display = "none";
  }
}
</script>

{% endblock %}
