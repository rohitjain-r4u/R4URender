{% extends "base.html" %}
{% block title %}Active Clients{% endblock %}

{% block content %}

<style>
  :root{
    --card-bg: #ffffff;
    --surface: #f8fafc;
    --muted: #6b7280;
    --border: #e6e9ee;
    --shadow: 0 6px 20px rgba(15,23,42,0.06);
    --accent-blue: #2563eb;
  }
  .clients-wrapper { max-width: 1200px; margin: 28px auto; padding: 12px 18px 36px; }
  .page-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px; }
  .page-title { font-size:28px; font-weight:700; margin:0; color:#111827; }
  .controls { display:flex; gap:12px; align-items:center; }
  .control { background:var(--card-bg); border:1px solid var(--border); padding:6px 10px; border-radius:8px; box-shadow: var(--shadow); }
  .control select, .control input { border:none; outline:none; font-size:14px; }
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 14px; align-items: stretch; margin-top: 16px; }
  .client-card { background: var(--card-bg); border-radius: 10px; border: 1px solid var(--border); padding: 18px 12px; box-shadow: var(--shadow); display: flex; flex-direction: column; justify-content: space-between; min-height: 110px; cursor: pointer; transition: transform .12s ease, box-shadow .12s ease; }
  .client-card:hover { transform: translateY(-6px); box-shadow: 0 14px 40px rgba(2,6,23,0.12); }
  .client-top { display:flex; flex-direction:column; align-items:center; gap:10px; }
  .client-badge { display:inline-block; padding: 8px 14px; border-radius: 999px; font-weight:700; color: #fff; font-size: 14px; text-align:center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
  .client-name-visible { display:block; margin-top: 6px; text-align:center; font-weight:700; color:#0f172a; font-size:13px; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .client-count { display:block; text-align:center; margin-top: 8px; font-weight:800; color: var(--accent-blue); text-decoration: underline; text-decoration-color: rgba(37,99,235,0.65); text-underline-offset: 6px; cursor: pointer; }
  .client-count.small { font-size: 13px; }
  .client-count.large { font-size: 18px; }
  .empty-state { text-align:center; color:var(--muted); padding:36px; }
  @media (max-width:880px){ .page-header { flex-direction: column; align-items: stretch; } .controls { justify-content: space-between; } .client-card { min-height: 86px; padding: 12px; } .client-name-visible { font-size: 13px; } }
  .popup-table-wrapper { overflow-x:auto; }
  .back-btn { display:inline-block; margin-bottom:8px; padding:6px 10px; border-radius:8px; background:#111827; color:#fff; text-decoration:none; }
  .client-card:focus { outline: 3px solid rgba(37,99,235,0.25); outline-offset: 3px; }
  @media (prefers-reduced-motion: reduce) {
    .client-card { transition: none; transform: none; }
  }
  .pagination {
    display: flex;
    justify-content: center;
    margin: 20px 0;
    gap: 8px;
  }
  .pagination button {
    padding: 8px 12px;
    border: 1px solid var(--border);
    background: var(--card-bg);
    border-radius: 6px;
    cursor: pointer;
  }
  .pagination button:hover:not(:disabled) {
    background: var(--accent-blue);
    color: white;
  }
  .pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .pagination-info {
    text-align: center;
    margin: 10px 0;
    color: var(--muted);
    font-size: 14px;
  }

/* ===== Assistant safe patch: styling only (no JS changes) ===== */
.cand-popup table, .cand-popup th, .cand-popup td { border: 1px solid var(--border); border-collapse: collapse; }
.cand-popup th, .cand-popup td { padding: 10px 12px; }
.cand-popup th:nth-child(1), .cand-popup td:nth-child(1) { width: 300px; max-width: 300px; }
.cand-popup th:nth-child(2), .cand-popup td:nth-child(2) { width: 450px; max-width: 450px; }
/* hide any Back links in popup */
.back-btn { display: none !important; }
/* ensure visible boundaries for tables generated without cand-popup class */
.popup-table-wrapper table, .popup-table-wrapper th, .popup-table-wrapper td { border: 1px solid var(--border); border-collapse: collapse; }



.req-summary { width:100%; box-sizing:border-box; margin-top:12px; }
.req-summary .tile { flex:1 1 160px; min-width:120px; max-width:300px;
  background:#fff; border-radius:10px; padding:8px; border:1px solid #e5e7eb; text-align:center; }
.req-summary .val { font-weight:700; font-size:16px; color:#1e3a8a; }
.req-summary .lbl { font-size:12px; color:#6b7280; }


/* Summary tiles - scoped and robust */
.req-summary{width:100%;box-sizing:border-box;margin:12px 0;padding:8px 12px;background:transparent}
.req-tiles{display:flex;gap:12px;flex-wrap:nowrap;align-items:center;justify-content:flex-start;overflow-x:auto;padding-bottom:6px}
.req-tile{background:var(--card-bg,#fff);border:1px solid rgba(15,23,42,0.06);flex:0 0 auto;padding:10px 14px;border-radius:10px;min-width:120px;display:flex;flex-direction:column;align-items:center;box-shadow:0 1px 2px rgba(2,6,23,0.04);margin:4px}
.req-val{font-size:18px;font-weight:800}
.req-label{font-size:12px;color:var(--muted,#6b7280);margin-top:6px}
@media (max-width:900px){ .req-tile{min-width:110px} }
</style>

<div class="clients-wrapper">
  <div class="page-header">
    <h1 class="page-title">Active Clients</h1>

    <div class="controls" role="region" aria-label="Client controls">
      <div class="control" title="Sort clients">
        <label style="font-size:12px;color:var(--muted);margin-right:6px;">Sort</label>
        <select id="sort-select" aria-label="Sort clients">
          <option value="name_asc">Name Aâ€“Z</option>
          <option value="name_desc">Name Zâ€“A</option>
          <option value="count_desc">Active Req (High â†’ Low)</option>
          <option value="count_asc">Active Req (Low â†’ High)</option>
        </select>
      </div>

      <div class="control" style="display:flex;gap:8px;align-items:center;">
        <label style="font-size:12px;color:var(--muted);margin-right:4px;">Filter</label>
        <input id="filter-min" type="number" min="0" placeholder="min" style="width:60px;padding:6px;border-radius:6px;border:1px solid var(--border)" aria-label="Minimum active requirements" />
        <input id="filter-max" type="number" min="0" placeholder="max" style="width:60px;padding:6px;border-radius:6px;border:1px solid var(--border)" aria-label="Maximum active requirements" />
        <button id="filter-apply" style="padding:6px 10px;border-radius:8px;background:#111827;color:#fff;border:none;cursor:pointer;font-weight:700" aria-label="Apply filters">
      
      </div>
    </div>
  </div>

  <div id="loading" aria-live="polite" style="color:var(--muted)">Loading clientsâ€¦</div>

  <div id="clients-grid" class="grid" aria-describedby="loading" role="list"></div>

  <div id="empty" class="empty-state" style="display:none;">No active clients found</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const COLORS = ["#2563eb", "#16a34a", "#db2777", "#f59e0b", "#9333ea", "#0d9488", "#ea580c", "#be123c", "#7c3aed", "#059669", "#0f766e", "#1e3a8a"];
  const GRID = document.getElementById('clients-grid');
  const EMPTY = document.getElementById('empty');

  function escapeHtml(s) { return String(s || '').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[ch])); }
  function hashCode(str) { let h = 2166136261 >>> 0; for (let i = 0; i < (str || '').length; i++) { h ^= str.charCodeAt(i); h = Math.imul(h, 16777619) >>> 0; } return h; }

  let clientsData = [];

  async function loadClients() {
    try {
      document.getElementById('loading').textContent = 'Loading clientsâ€¦';

      // Fetch clients list and all-summary in parallel
      const [resClients, resAll] = await Promise.all([
        fetch('/api/clients'),
        fetch('/api/clients/all_summary')
      ]);

      if (!resClients.ok || !resAll.ok) throw new Error('Network response not ok');

      const items = await resClients.json();
      const allSummary = await resAll.json();

      clientsData = (items || []).filter(i => i && i.client_name).map(i => ({
        client_name: i.client_name,
        active_requirements: parseInt(i.active_requirements || 0, 10)
      }));

      // Prepend "All Clients" card so it always appears first
      if (allSummary && typeof allSummary.active_requirements !== 'undefined') {
        clientsData.unshift({
          client_name: allSummary.client_name || 'All Clients',
          active_requirements: parseInt(allSummary.active_requirements || 0, 10)
        });
      }

      renderClients(clientsData);
    } catch (err) {
      console.error('Failed to load clients', err);
      document.getElementById('loading').textContent = 'Error loading clients';
    }
  }

  function renderClients(items) {
    GRID.innerHTML = '';
    document.getElementById('loading').textContent = '';
    if (!items.length) { EMPTY.style.display = 'block'; return; } else { EMPTY.style.display = 'none'; }

    items.forEach((it, i) => {
      const card = document.createElement('div');
      card.className = 'client-card';
      card.setAttribute('role','listitem');
      card.setAttribute('tabindex','0');
      card.dataset.clientName = it.client_name;

      const top = document.createElement('div');
      top.className = 'client-top';

      const badge = document.createElement('div');
      badge.className = 'client-badge';
      badge.textContent = it.client_name;
      const colorIdx = Math.abs(hashCode(it.client_name || String(i))) % COLORS.length;
      badge.style.background = COLORS[colorIdx];
      badge.title = it.client_name;

      const visibleName = document.createElement('div');
      visibleName.className = 'client-name-visible';
      visibleName.textContent = it.client_name;
      visibleName.title = it.client_name;

      top.appendChild(badge);
      top.appendChild(visibleName);

      const count = document.createElement('div');
      count.className = 'client-count ' + (it.active_requirements > 5 ? 'large' : 'small');
      count.textContent = String(it.active_requirements || 0);
      count.title = 'Click to view requirements';

      card.appendChild(top);
      card.appendChild(count);
      GRID.appendChild(card);
    });
  }

  document.getElementById('sort-select').addEventListener('change', applySortFilter);
  document.getElementById('filter-apply').addEventListener('click', applySortFilter);

  function applySortFilter() {
    const sortVal = document.getElementById('sort-select').value;
    const minVal = parseInt(document.getElementById('filter-min').value || 0, 10);
    const maxRaw = document.getElementById('filter-max').value;
    const maxVal = maxRaw === '' ? Infinity : parseInt(maxRaw, 10);

    let filtered = clientsData.filter(it => it.active_requirements >= minVal && it.active_requirements <= maxVal);
    switch (sortVal) {
      case 'name_asc': filtered.sort((a,b) => a.client_name.localeCompare(b.client_name)); break;
      case 'name_desc': filtered.sort((a,b) => b.client_name.localeCompare(a.client_name)); break;
      case 'count_desc': filtered.sort((a,b) => b.active_requirements - a.active_requirements); break;
      case 'count_asc': filtered.sort((a,b) => a.active_requirements - b.active_requirements); break;
    }
    renderClients(filtered);
  }

  // helper to normalize event target (handle text nodes)
  function elementFromEventTarget(target) {
    return (target && target.nodeType === 3) ? target.parentElement : target;
  }

  GRID.addEventListener('click', function (ev) {
    const tgt = elementFromEventTarget(ev.target);
    const countEl = tgt && tgt.closest && tgt.closest('.client-count');
    if (countEl) {
      const card = tgt.closest && tgt.closest('.client-card');
      if (!card) return;
      const clientName = card.dataset.clientName || (card.querySelector && card.querySelector('.client-name-visible') && card.querySelector('.client-name-visible').textContent.trim());
      if (clientName) {
        openRequirementsPopup(clientName);
      }
      return;
    }

    const card = tgt.closest && tgt.closest('.client-card');
    if (!card) return;
    const clientName = card.dataset.clientName || (card.querySelector && card.querySelector('.client-name-visible') && card.querySelector('.client-name-visible').textContent.trim());
    if (clientName) {
      openRequirementsPopup(clientName);
    }
  });

  GRID.addEventListener('keydown', function (ev) { if (ev.key !== 'Enter') return; const card = ev.target.closest('.client-card'); if (!card) return; const clientName = card.dataset.clientName || (card.querySelector && card.querySelector('.client-name-visible') && card.querySelector('.client-name-visible').textContent.trim()); if (clientName) openRequirementsPopup(clientName); });

  // Add pagination controls to the HTML
  function addPaginationControls(pagination) {
    const { page, pages } = pagination;
    return `
      <div class="pagination">
        <button onclick="loadRequirementsPage(${page - 1})" ${page <= 1 ? 'disabled' : ''}>Previous</button>
        <span>Page ${page} of ${pages}</span>
        <button onclick="loadRequirementsPage(${page + 1})" ${page >= pages ? 'disabled' : ''}>Next</button>
      </div>
    `;
  }

  // Function to load a different page of requirements
  async function loadRequirementsPage(page) {
    const win = window; // This function will be called from the popup window
    
    if (page < 1 || page > win._totalPages) return;
    
    win.document.getElementById('popup-content').innerHTML = '<div class="muted">Loadingâ€¦</div>';
    
    try {
      const clientName = win._clientName;
      const perPage = win._perPage;
      
      let url = clientName === 'All Clients' 
        ? `/api/client/requirements_details_all?page=${page}&per_page=${perPage}`
        : `/api/client/requirements_details?client_name=${encodeURIComponent(clientName)}&page=${page}&per_page=${perPage}`;
      
      const reqRes = await fetch(url);
      if (!reqRes.ok) throw new Error('Failed to fetch requirements');
      const data = await reqRes.json();
      const rows = data.requirements || [];
      // apply advanced filters if provided (from opener / parent)
      try {
        const adv = (typeof win._advancedFilters === 'object' && win._advancedFilters) ? win._advancedFilters : (window.opener && window.opener._advancedFilters) ? window.opener._advancedFilters : {};
        let _rows = Array.isArray(rows) ? rows.slice() : [];
        if (adv) {
          _rows = _rows.filter(r => {
            // Less than 5 Profiles
            if (adv.less5_notRejected) {
              const nr = Number(r.candidates_not_rejected || r.candidates_not_rejected_count || 0);
              if (nr >= 5) return false;
            }
            // No candidates added in last 4 days
            if (adv.no_added_last_4_days) {
              // prefer explicit 4d field if present, otherwise fall back to last 7 days (best-effort)
              const added7 = Number(r.candidates_last_7_days || r.candidates_added_last_7_days || 0);
              const added4 = Number(r.candidates_last_4_days || r.candidates_added_last_4_days || added7);
              if (added4 > 0) return false;
            }
            // Unassigned requirements (assigned_to empty)
            if (adv.unassigned_reqs) {
              const assigned = (r.assigned_to || r.assigned || '').toString().trim();
              if (assigned.length > 0) return false;
            }
            return true;
          });
        }
        rows = _rows;
      } catch (e) { /* ignore filter errors and proceed with original rows */ }

      
      if (!rows.length) {
        win.document.getElementById('popup-content').innerHTML = '<div class="muted">No requirements found.</div>';
        return;
      }
      
      win._requirementsRows = rows;
      win._currentPage = data.pagination.page;
      win._totalPages = data.pagination.pages;
      
      // Build the table HTML
      let html = '<div style="margin-bottom:8px;" class="muted">Click any candidate count to view the candidate list for that requirement (opens below in same window).</div>';
      html += addPaginationControls(data.pagination);
      html += '<div class="popup-table-wrapper"><table><thead><tr>'
        + '<th>Client Name</th>'
        + '<th>Requirement Name</th>'
        + '<th>Client POC</th>'
        + '<th>Assigned To</th>'
        + '<th style="text-align:right">Total Candidates</th>'
        + '<th style="text-align:right">Added (7d)</th>'
        + '<th style="text-align:right">Not Rejected</th>'
        + '<th style="text-align:right">R2 Candidates</th>'
        + '<th style="text-align:right">R3 Candidates</th>'
        + '<th style="text-align:right">HR Rounds</th>'
        + '<th style="text-align:right">Offered</th>'
        + '</tr></thead><tbody>';
      
      rows.forEach(r => {
        const reqName = r.requirement_name || '';
        const client = r.client_name || win._clientName || '';
        const clientPoc = r.client_poc || '';
        const assigned = r.assigned_to || '';
        const reqId = r.requirement_id || r.requirement || '';
        const totalCandidates = Number(r.total_candidates || 0);
        const added7 = Number(r.candidates_last_7_days || 0);
        const notRejected = Number(r.candidates_not_rejected || 0);
        const r2Candidates = Number(r.r2_candidates || 0);
        const r3Candidates = Number(r.r3_candidates || 0);
        const hrRounds = Number(r.hr_rounds || 0);
        const offered = Number(r.offered_count || 0);

        html += '<tr>'
          + `<td>${escapeHtml(client)}</td>`
          + `<td>${escapeHtml(reqName)}</td>`
          + `<td>${escapeHtml(clientPoc)}</td>`
          + `<td>${escapeHtml(assigned)}</td>`
          + `<td style="text-align:right"><a href="#" class="count-link" data-reqid="${escapeHtml(reqId)}" data-reqname="${escapeHtml(reqName)}" data-counttype="total">${totalCandidates}</a></td>`
          + `<td style="text-align:right"><a href="#" class="count-link" data-reqid="${escapeHtml(reqId)}" data-reqname="${escapeHtml(reqName)}" data-counttype="added">${added7}</a></td>`
          + `<td style="text-align:right"><a href="#" class="count-link" data-reqid="${escapeHtml(reqId)}" data-reqname="${escapeHtml(reqName)}" data-counttype="not_rejected">${notRejected}</a></td>`
          + `<td style="text-align:right"><a href="#" class="count-link" data-reqid="${escapeHtml(reqId)}" data-reqname="${escapeHtml(reqName)}" data-counttype="r2">${r2Candidates}</a></td>`
          + `<td style="text-align:right"><a href="#" class="count-link" data-reqid="${escapeHtml(reqId)}" data-reqname="${escapeHtml(reqName)}" data-counttype="r3">${r3Candidates}</a></td>`
          + `<td style="text-align:right"><a href="#" class="count-link" data-reqid="${escapeHtml(reqId)}" data-reqname="${escapeHtml(reqName)}" data-counttype="hr">${hrRounds}</a></td>`
          + `<td style="text-align:right"><a href="#" class="count-link" data-reqid="${escapeHtml(reqId)}" data-reqname="${escapeHtml(reqName)}" data-counttype="offered">${offered}</a></td>`
          + '</tr>';
      });

      html += '</tbody></table></div>';
      win.document.getElementById('popup-content').innerHTML = html;

      // Attach delegated click handling inside the popup window
      if (win._popupClickHandler && typeof win._popupClickHandler === 'function') {
        try { win.document.removeEventListener('click', win._popupClickHandler); } catch (er) { /* ignore */ }
      }

      win._popupClickHandler = function popupClickHandler(e) {
        const a = e.target.closest && e.target.closest('.count-link');
        if (!a) return;
        e.preventDefault();
        const reqId = a.getAttribute('data-reqid');
        const reqName = a.getAttribute('data-reqname');
        const countType = a.getAttribute('data-counttype') || a.getAttribute('data-count-type') || (a.dataset && a.dataset.counttype);
        openCandidatesListInPopup(win, reqId, reqName, countType);
      };

      win.document.addEventListener('click', win._popupClickHandler);

    } catch (err) {
      win.document.getElementById('popup-content').innerHTML = `<div style="color:#c00">Failed to load data: ${escapeHtml(err.message || '')}</div>`;
      console.error(err);
    }
  }

  // Helper function for candidate pagination controls
  function addCandidatePaginationControls(pagination) {
    const { page, pages } = pagination;
    return `
      <div class="pagination candidate-pagination">
        <button class="prev-btn" ${page <= 1 ? 'disabled' : ''}>Previous</button>
        <span>Page ${page} of ${pages}</span>
        <button class="next-btn" ${page >= pages ? 'disabled' : ''}>Next</button>
      </div>
      <div class="pagination-info">Showing ${pagination.per_page} candidates per page</div>
    `;
  }

  // Function to load a different page of candidates
  async function loadCandidatePage(win, page) {
    if (page < 1 || page > win._candidateTotalPages) return;
    
    win.document.getElementById('popup-content').innerHTML = '<div class="muted">Loading candidatesâ€¦</div>';
    
    try {
      const requirementId = win._requirementId;
      const countType = win._countType;
      const perPage = win._candidatePerPage;
      
      let url = `/api/candidates?requirement_id=${encodeURIComponent(requirementId)}`;
      if (countType) url += `&count_type=${encodeURIComponent(countType)}`;
      url += `&page=${page}&per_page=${perPage}`;
      
      const listRes = await fetch(url);
      if (!listRes.ok) throw new Error('Failed to fetch candidates');
      const data = await listRes.json();
      const candidateDetails = data.data || [];
      
      // Update pagination info
      win._candidateCurrentPage = data.pagination.page;
      win._candidateTotalPages = data.pagination.pages;
      
      // Build candidates table with pagination controls
      let html = `
        <div><h2 style="display:inline-block;margin-left:12px;font-size:16px;">Candidates for: ${escapeHtml(win._requirementName || requirementId)}</h2></div>`;
      
      // Add pagination controls
      html += addCandidatePaginationControls(data.pagination);
      
      html += '<div class="popup-table-wrapper"><table><thead><tr>'
        + '<th>Name</th>'
        + '<th>Email</th>'
        + '<th>Phone</th>'
        + '<th>Company</th>'
        + '<th>Location</th>'
        + '<th>CTC (Current)</th>'
        + '<th>ECTC (Expected)</th>'
        + '<th>Notice Period</th>'
        + '<th>Profile Status</th>'
        + '<th>Calling Status</th>'
        + '<th>Offer Details</th>'
        + '<th>Comments</th>'
        + '<th>Added By</th>'
        + '<th>Added Date</th>'
        + '</tr></thead><tbody>';
      
      candidateDetails.forEach(c => {
        const name = c.candidate_name || c.name || c.full_name || '';
        const email = (c.emails && (Array.isArray(c.emails) ? c.emails.join(', ') : c.emails)) || c.email || '';
        const phone = (c.phones && (Array.isArray(c.phones) ? c.phones.join(', ') : c.phones)) || c.phone || '';
        const company = c.company || c.current_company || c.employer || '';
        const location = c.location || c.current_location || '';
        const ctc = c.current_ctc || c.ctc || c.current_salary || '';
        const ectc = c.expected_ctc || c.ectc || c.expected_salary || '';
        const notice = c.notice_period || c.notice || '';
        const profileStatus = c.profile_status || c.status || '';
        const callingStatus = c.calling_status || c.calling || '';
        const offerDetails = c.offer_details || c.offer || '';
        const comments = c.comments || c.notes || '';
        const addedBy = c.added_by || c.added_by_name || c.created_by || '';
        const addedDate = c.added_date || c.created_at || c.added_on || '';

        html += '<tr>'
          + `<td>${escapeHtml(name)}</td>`
          + `<td>${escapeHtml(email)}</td>`
          + `<td>${escapeHtml(phone)}</td>`
          + `<td>${escapeHtml(company)}</td>`
          + `<td>${escapeHtml(location)}</td>`
          + `<td>${escapeHtml(ctc)}</td>`
          + `<td>${escapeHtml(ectc)}</td>`
          + `<td>${escapeHtml(notice)}</td>`
          + `<td>${escapeHtml(profileStatus)}</td>`
          + `<td>${escapeHtml(callingStatus)}</td>`
          + `<td>${escapeHtml(offerDetails)}</td>`
          + `<td>${escapeHtml(comments)}</td>`
          + `<td>${escapeHtml(addedBy)}</td>`
          + `<td>${escapeHtml(addedDate)}</td>`
          + '</tr>';
      });

      html += '</tbody></table></div>';
      win.document.getElementById('popup-content').innerHTML = html;

      // Add event listener for pagination buttons
      const prevBtn = win.document.querySelector('.candidate-pagination .prev-btn');
      const nextBtn = win.document.querySelector('.candidate-pagination .next-btn');
      
      if (prevBtn) {
        prevBtn.onclick = () => loadCandidatePage(win, data.pagination.page - 1);
      }
      if (nextBtn) {
        nextBtn.onclick = () => loadCandidatePage(win, data.pagination.page + 1);
      }
      
      // Re-attach back button handler
      const backBtn = win.document.getElementById('back-to-reqs');
      if (backBtn) {
        backBtn.addEventListener('click', function(e) {
          e.preventDefault();
          // Go back to requirements view
          openRequirementsPopup(win._clientName);
        });
      }
      
    } catch (err) {
      win.document.getElementById('popup-content').innerHTML = `<div style="color:#c00">Failed to load data: ${escapeHtml(err.message || '')}</div>`;
      console.error(err);
    }
  }

  // Opens a popup window showing requirements. Clicking candidate counts in that popup
  // will replace the popup content with the candidate list for that requirement (same popup window).
    // Opens a popup window showing requirements. Clicking candidate counts in that popup
  // will replace the popup content with the candidate list for that requirement (same popup window).
  
  // Opens a popup window showing requirements. Enhanced: sticky headers, pinned first cols,
  // clickable column sorting, quick filters, page-size selector, export/copy, heatmap numbers,
  // recent-row highlighting, tooltips and improved pagination chips. Applies for All Clients and individual client popups.
  
  // Opens a popup window showing requirements â€” redesigned with dashboard-style visuals.
  
  // Opens a popup window showing requirements â€” v2 visual fixes:
  // - Client name shown as full colored pill (no truncation)
  // - All numeric columns styled consistently as clickable-blue look
  // - Top action bar upgraded with gradient background and vivid chips/buttons
  
  // Opens a popup window showing requirements â€” v3 fixes:
  // - Fix filter "stuck at 0" by making filter application stateless and explicit
  // - Reduce Requirement column width and other columns so the table fits better
  // - Chips always show light background; active chips turn blue
  
  // Opens a popup window showing requirements â€” v4 final adjustments:
  // - Dark boundary for search & filters, red placeholder/text inside search
  // - Filter chips default light green, turn blue when active
  // - Remove the floating page-number circle and move pagination chips to bottom
  // - Keep header row always frozen and aligned with pinned columns
  // - Reduce Requirement and Assigned To column widths (allow wrapping onto next line)
  async function openRequirementsPopup(clientName) {
    const win = window.open('', '_blank', 'width=1200,height=760,scrollbars=yes');
    // pass advanced filter choices to popup window
    try {
      win._advancedFilters = {
        less5_notRejected: !!(document.getElementById('filter-less5-notrejected') && document.getElementById('filter-less5-notrejected').checked),
        no_added_last_4_days: !!(document.getElementById('filter-no-added-4d') && document.getElementById('filter-no-added-4d').checked),
        unassigned_reqs: !!(document.getElementById('filter-unassigned-reqs') && document.getElementById('filter-unassigned-reqs').checked)
      };
    } catch (e) { win._advancedFilters = {}; }

    if (!win) { alert('Popup blocked. Please allow popups for this site to view client requirements.'); return; }
    win.document.title = 'Requirements â€” ' + clientName;

    const style = `
      :root{
        --bg:#f8fafc;
        --card:#ffffff;
        --muted:#64748b;
        --accent:#2563eb;
        --accent2:#6d28d9;
        --navy:#0f172a;
        --success:#16a34a;
        --accent-green:#059669; /* vivid green */
        --accent-green2:#10b981;
        --chip-default: linear-gradient(90deg, rgba(5,150,105,0.22), rgba(16,185,129,0.18)); /* brighter vivid green gradient */
      }
      html,body{height:100%;background:var(--bg);margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:var(--navy);}
      .canvas{padding:18px;max-width:1180px;margin:0 auto;}
      .card{background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.08);padding:16px;border:1px solid rgba(15,23,42,0.04);}
      h1{margin:0 0 12px 0;font-size:22px;font-weight:700;color:var(--navy);}

      /* top band */
      .top-band{border-radius:10px;padding:12px;background:linear-gradient(90deg, rgba(37,99,235,0.06), rgba(109,40,217,0.03));display:flex;flex-direction:column;gap:10px;margin-bottom:12px;}
      .top-row{display:flex;gap:12px;align-items:center;margin-bottom:6px;flex-wrap:wrap;}
      /* dark boundary & red text for search */
      .search-input{padding:10px 12px;border-radius:10px;border:2px solid rgba(15,23,42,0.12);min-width:240px;box-shadow:none;color: #000; font-weight:700;}
      .search-input::placeholder{color: #9CA3AF;} /* pale red placeholder */
      .select,.select-sm{padding:9px 10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);}
      .btn{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600;box-shadow:none;}
      .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;}
      .btn.ghost{background:transparent;border:1px solid rgba(15,23,42,0.06);color:var(--navy);}

      /* chips: default light green, active blue */
      .chips{display:flex;gap:8px;align-items:center;margin:8px 0;flex-wrap:wrap;}
      .chip{padding:8px 12px;border-radius:999px;background: #16a34a; color:#fff;  cursor:pointer;border:1px solid rgba(15,23,42,0.04);transition:all .18s ease; box-shadow:0 4px 12px rgba(5,150,105,0.08);}
      .chip{box-shadow: 0 4px 12px rgba(5,150,105,0.08);}
      .chip.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;border-color:transparent;box-shadow:0 6px 18px rgba(37,99,235,0.12);transform:translateY(-1px);}

      .results-meta{margin-left:auto;color:var(--muted);font-size:14px;}

      .table-wrap{overflow:auto;border-radius:8px;border:1px solid rgba(15,23,42,0.04);background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.4));padding:8px;}
      table{width:100%;border-collapse:collapse;min-width:900px;}
      thead th{position:sticky;top:0;background:linear-gradient(90deg,var(--navy),#1e293b);color:#fff;padding:10px 12px;text-align:left;font-weight:700;font-size:13px;letter-spacing:0.01em;z-index:12;border-bottom:1px solid rgba(255,255,255,0.06);}
      thead th.pinned{position:sticky;left:0;z-index:13;}
      thead th.pinned.col2{position:sticky;left:200px;z-index:13;}
      tbody td{padding:10px 12px;border-bottom:1px solid rgba(15,23,42,0.04);vertical-align:middle;background:transparent;}
      tbody tr:nth-child(even) td{background: #fbfdfe;}
      tbody tr:hover td{background:#f1f5f9;}

      /* Column width adjustments and wrapping for requirement and assigned columns */
      th:nth-child(1), td:nth-child(1){width:200px;max-width:200px;}
      th:nth-child(2), td:nth-child(2){max-width:100px;white-space:normal;word-break:break-word;}
      th:nth-child(3), td:nth-child(3){width:120px;max-width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
      th:nth-child(4), td:nth-child(4){width: 240px;max-width:240px;white-space:normal;word-break:break-word;}
      th:nth-child(5), td:nth-child(5){width:100px;max-width:100px;}
      th:nth-child(6), td:nth-child(6){width:100px;max-width:100px;}
      th:nth-child(7), td:nth-child(7){width:90px;max-width:90px;}
      th:nth-child(8), td:nth-child(8){width:70px;max-width:70px;}
      th:nth-child(9), td:nth-child(9){width:70px;max-width:70px;}
      th:nth-child(10), td:nth-child(10){width:70px;max-width:70px;}
      th:nth-child(11), td:nth-child(11){width:70px;max-width:70px;}

      td.pinned{position:sticky;left:0;background:transparent;z-index:11;min-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
      td.pinned.col2{left:200px;min-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:normal;}

      .client-pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;color:#fff;font-weight:700;font-size:13px;white-space:nowrap;}
      .req-name{font-weight:700;color:var(--navy);white-space:normal;overflow:hidden;text-overflow:ellipsis;}

      .badge-new{margin-left:8px;background:var(--success);color:#fff;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700;}

      .num-link,.num-cell{color:var(--accent);text-decoration:underline;font-weight:700;cursor:default;}
      .num-link.clickable{cursor:pointer;}

      .progress-ctr{height:8px;background:rgba(15,23,42,0.06);border-radius:999px;overflow:hidden;display:inline-block;width:100px;margin-left:8px;vertical-align:middle;}
      .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%;border-radius:999px;transition:width .4s ease;}

      .page-chips{display:flex;gap:8px;justify-content:center;margin:16px 0;}
      .page-chip{padding:8px 12px;border-radius:999px;border:1px solid rgba(15,23,42,0.06);cursor:pointer;}
      .page-chip.active{background:var(--accent);color:#fff;border-color:transparent;box-shadow:0 6px 18px rgba(37,99,235,0.12);}

      .small-muted{color:var(--muted);font-size:13px;}
    `;

    win.document.body.innerHTML = `<div class="canvas"><div class="card"><style>${style}</style>
      <h1>Requirements for ${escapeHtml(clientName)}</h1>
      <div class="top-band">
        <div class="top-row">
          <input id="popup-search" class="search-input" placeholder="Search requirement, client, assigned" />
          <select id="popup-sort" class="select" title="Sort">
            <option value="date_desc">Latest Requirement</option>
            <option value="client_name_asc" selected>Client Name Aâ€“Z</option>
            <option value="client_name_desc">Client Name Zâ€“A</option>
          </select>
          <select id="page-size" class="select-sm" title="Rows per page"><option value="25">25</option><option value="50">50</option><option value="100" selected>100</option></select>

          <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
            <button id="export-csv" class="btn primary" title="Export visible rows to CSV">â¬‡ Export CSV</button>
            <button id="copy-clip" class="btn ghost" title="Copy visible rows">ðŸ“‹ Copy</button>
          </div>
        </div>
        <div class="chips">
          <div class="chip active" data-filter="all">All</div>
          <div class="chip" data-filter="active">Only Active Clients</div>
          <div class="chip" data-filter="gt10">With &gt;10 candidates</div>
          <div class="chip" data-filter="7d">Added in last 7 days</div>
          <div class="chip" data-filter="less5_nr">Less than 5 Profiles</div>
          <div class="chip" data-filter="no_added_4d">No Candidates(4d)</div>
          <div class="chip" data-filter="unassigned_reqs">Unassigned Reqs</div>
          <div class="results-meta" id="results-count">Loadingâ€¦</div>
        </div>
      </div>

      <div id="popup-content"><div class="small-muted">Loadingâ€¦</div></div>
    </div></div>`;

    // Helpers
    function parseDate(d){ if(!d) return NaN; const dt=new Date(d); return isNaN(dt.getTime())?NaN:dt.getTime(); }
    function getReqTimestamp(r){ const cand=r.requirement_created_at||r.created_at||r.added_date||r.added_on||r.posted_date||r.last_updated||r.updated_at||r.added_on_date; const t=parseDate(cand); return isNaN(t)?0:t; }
    function avatarColor(seed){ const colors=['#ef4444','#f97316','#f59e0b','#eab308','#10b981','#06b6d4','#3b82f6','#7c3aed','#ec4899']; const idx=Math.abs(seed.split('').reduce((s,c)=>s + c.charCodeAt(0),0)) % colors.length; return colors[idx]; }

    function buildPaginationChips(page,pages){ let html='<div class="page-chips">'; function chip(p,label,cls=''){ html+=`<div class="page-chip ${cls}" data-page="${p}">${label}</div>`; } if(page>1) chip(page-1,'â€¹ Prev'); const start=Math.max(1,page-2); const end=Math.min(pages,start+4); for(let p=start;p<=end;p++) chip(p,p,p===page?'active':''); if(end<pages){ html+=`<div class="page-chip" data-page="${Math.max(1,end+1)}">â€¦</div>`; chip(pages,pages);} if(page<pages) chip(page+1,'Next â€º'); html+='</div>'; return html; }

    function rowsToCSV(rows){ const header=['Client Name','Requirement Name','Client POC','Assigned To','Total Candidates','Added (7d)','Not Rejected','R2','R3','HR','Offered']; const csv=[header.join(',')]; rows.forEach(r=>{ const line=[`"${(r.client_name||'').replace(/"/g,'""')}"`,`"${(r.requirement_name||'').replace(/"/g,'""')}"`,`"${(r.client_poc||'').replace(/"/g,'""')}"`,`"${(r.assigned_to||'').replace(/"/g,'""')}"`,r.total_candidates||0,r.candidates_last_7_days||0,r.candidates_not_rejected||0,r.r2_candidates||0,r.r3_candidates||0,r.hr_rounds||0,r.offered_count||0].join(','); csv.push(line); }); return csv.join('\n'); }

    // Render table: pagination chips now appended after table
    



function renderSummary(rows) {
  try {
    rows = Array.isArray(rows) ? rows : [];
    const totals = { reqs:0, total:0, added7:0, notRejected:0, r2:0, r3:0, hr:0, offered:0 };
    rows.forEach(r => {
      totals.reqs++;
      totals.total += Number(r.total_candidates || 0);
      totals.added7 += Number(r.candidates_last_7_days || r.candidates_added_last_7_days || 0);
      totals.notRejected += Number(r.candidates_not_rejected || r.candidates_not_rejected_count || 0);
      totals.r2 += Number(r.r2_candidates || 0);
      totals.r3 += Number(r.r3_candidates || 0);
      totals.hr += Number(r.hr_rounds || 0);
      totals.offered += Number(r.offered_count || 0);
    });

    const tiles = [
      {k:'Requirements', v:totals.reqs, color:'var(--accent-blue,#2563eb)', type:'reqs'},
      {k:'Total Candidates', v:totals.total, color:'var(--accent-green,#10b981)', type:'total'},
      {k:'Added (7d)', v:totals.added7, color:'var(--accent-orange,#f97316)', type:'added'},
      {k:'Not Rejected', v:totals.notRejected, color:'var(--accent-purple,#8b5cf6)', type:'not_rejected'},
      {k:'R2', v:totals.r2, color:'var(--accent-blue,#2563eb)', type:'r2'},
      {k:'R3', v:totals.r3, color:'var(--accent-yellow,#f59e0b)', type:'r3'},
      {k:'HR', v:totals.hr, color:'var(--accent-green2,#16a34a)', type:'hr'},
      {k:'Offered', v:totals.offered, color:'var(--accent-indigo,#7c3aed)', type:'offered'}
    ];

    // ensure style exists in popup head
    if (!win.document.getElementById('req-summary-style')) {
      const style = win.document.createElement('style');
      style.id = 'req-summary-style';
      style.type = 'text/css';
      style.appendChild(win.document.createTextNode(`
        .req-summary{width:100%;box-sizing:border-box;margin:12px 0;padding:8px 12px;background:transparent}
        .req-tiles{display:flex;gap:12px;flex-wrap:nowrap;align-items:center;justify-content:flex-start;overflow-x:auto;padding-bottom:6px}
        .req-tile{background:var(--card-bg,#fff);border:1px solid rgba(15,23,42,0.06);padding:10px 14px;border-radius:10px;min-width:120px;display:flex;flex-direction:column;align-items:center;box-shadow:0 1px 2px rgba(2,6,23,0.04);margin:4px;flex:0 0 auto}
        .req-val{font-size:18px;font-weight:800}
        .req-label{font-size:12px;color:var(--muted,#6b7280);margin-top:6px}
        .summary-num{background:none;border:none;padding:0;margin:0;font:inherit;cursor:pointer;text-decoration:underline}
        @media (max-width:900px){ .req-tile{min-width:110px} }
      `));
      (win.document.head || win.document.getElementsByTagName('head')[0] || win.document.documentElement).appendChild(style);
    }

    const summaryWrap = win.document.createElement('div');
    summaryWrap.id = 'req-summary';
    summaryWrap.className = 'req-summary';
    const tilesWrap = win.document.createElement('div');
    tilesWrap.className = 'req-tiles';

    tiles.forEach(t => {
      const tile = win.document.createElement('div');
      tile.className = 'req-tile';
      const val = win.document.createElement('a');
      val.className = 'req-val summary-num';
      val.href = '#';
      val.setAttribute('data-counttype', t.type);
      val.textContent = t.v;
      const lbl = win.document.createElement('div');
      lbl.className = 'req-label';
      lbl.textContent = t.k;
      tile.appendChild(val);
      tile.appendChild(lbl);
      tilesWrap.appendChild(tile);
    });

    summaryWrap.appendChild(tilesWrap);

    const container = win.document.getElementById('popup-content');
    if (!container) return;
    const existing = container.querySelector('#req-summary');
    if (existing) existing.remove();
    const chips = container.querySelector('.chips') || container.querySelector('.filters') || container.querySelector('.chip-row');
    if (chips) chips.insertAdjacentElement('afterend', summaryWrap);
    else container.insertAdjacentElement('afterbegin', summaryWrap);

    // delegate clicks: attempt to show relevant rows and then delegate to existing per-row click if user wants
    tilesWrap.addEventListener('click', function(evt){
      const a = evt.target.closest('.summary-num');
      if (!a) return;
      evt.preventDefault();
      const type = a.getAttribute('data-counttype');
      try {
        // find rows where the .num-link for this type has a numeric > 0
        const rows = Array.from(container.querySelectorAll('tbody tr'));
        let shown = 0;
        rows.forEach(tr => {
          const cell = tr.querySelector('.num-link[data-counttype=\"' + type + '\"]');
          if (!cell) {
            // also check plain numeric cell
            const alt = tr.querySelector('[data-counttype=\"' + type + '\"]');
            if (alt && Number(alt.textContent.trim()) > 0) {
              tr.style.display = '';
              shown++;
            } else {
              tr.style.display = 'none';
            }
          } else {
            const v = Number(cell.textContent.trim()) || 0;
            if (v > 0) { tr.style.display = ''; shown++; } else tr.style.display = 'none';
          }
        });
        // if none found, show a brief message
        if (shown === 0) {
          try { win.alert('No matching candidates found for ' + type); } catch(e){}
          // restore rows
          rows.forEach(tr=> tr.style.display='');
          return;
        }
        // scroll to table area
        const tableTop = container.querySelector('.table-wrap');
        if (tableTop) tableTop.scrollIntoView({behavior:'smooth', block:'start'});
        // attach a small temporary banner to inform user rows filtered; clicking banner restores
        let banner = container.querySelector('#summary-filter-banner');
        if (!banner) {
          banner = win.document.createElement('div');
          banner.id = 'summary-filter-banner';
          banner.style.padding='8px 12px';
          banner.style.margin='8px 0';
          banner.style.border='1px dashed rgba(15,23,42,0.06)';
          banner.style.background='rgba(15,23,42,0.02)';
          banner.style.borderRadius='8px';
          banner.textContent = 'Showing only requirements with >0 ' + type + '. Click here to clear filter.';
          banner.style.cursor='pointer';
          banner.onclick = function(){ rows.forEach(tr=> tr.style.display=''); banner.remove(); };
          const chips = container.querySelector('.chips') || container.querySelector('.filters') || container.querySelector('.chip-row');
          if (chips) chips.insertAdjacentElement('afterend', banner); else container.insertAdjacentElement('afterbegin', banner);
        }
        // after filtering, focus first matching num-link so user can click it to open the detailed candidates
        const first = container.querySelector('.num-link[data-counttype=\"' + type + '\"]');
        if (first) try{ first.focus(); }catch(e){}
      } catch(e){ console.error('summary click handler error', e); }
    });

  } catch (e) {
    console.error('renderSummary error', e);
  }
}




function renderTable(rows,page=1,pageSize=100){
  
      const start=(page-1)*pageSize;
      const slice=rows.slice(start,start+pageSize);
      const maxTotal=Math.max(1,...rows.map(r=>Number(r.total_candidates||0)));
      const maxAdded=Math.max(1,...rows.map(r=>Number(r.candidates_last_7_days||0)));

      let html = `<div class="table-wrap"><table><thead><tr>
        <th class="pinned">Client</th>
        <th class="pinned col2">Requirement</th>
        <th>Client POC</th>
        <th>Assigned To</th>
        <th style="text-align:right">Total Candidates</th>
        <th style="text-align:right">Added (7d)</th>
        <th style="text-align:right">Not Rejected</th>
        <th style="text-align:right">R2</th>
        <th style="text-align:right">R3</th>
        <th style="text-align:right">HR</th>
        <th style="text-align:right">Offered</th>
      </tr></thead><tbody>`;

      const now=Date.now();
      slice.forEach(r=>{
        const client=r.client_name||clientName||'';
        const reqName=r.requirement_name||'';
        const poc=r.client_poc||'';
        const assigned=r.assigned_to||'';
        const reqId=r.requirement_id||r.requirement||'';
        const total=Number(r.total_candidates||0);
        const added=Number(r.candidates_last_7_days||0);
        const notRejected=Number(r.candidates_not_rejected||0);
        const r2=Number(r.r2_candidates||0);
        const r3=Number(r.r3_candidates||0);
        const hr=Number(r.hr_rounds||0);
        const offered=Number(r.offered_count||0);
        const ts=getReqTimestamp(r);
        const isRecent=(now-ts)<=(48*60*60*1000) && ts>0;
        const avatarBg=avatarColor(client);
        const totalPct=Math.round((total/Math.max(1,maxTotal))*100);
        const addedPct=Math.round((added/Math.max(1,maxAdded))*100);

        html+=`<tr ${isRecent?'class="recent"':''}>
          <td class="pinned"><span class="client-pill" style="background:${avatarBg};"><span class="pill-text">${escapeHtml(client)}</span></span></td>
          <td class="pinned col2"><div class="req-name">${escapeHtml(reqName)}</div>${isRecent?'<span class="badge-new">NEW</span>':''}</td>
          <td title="${escapeHtml(poc)}">${escapeHtml(poc)}</td>
          <td title="${escapeHtml(assigned)}">${escapeHtml(assigned)}</td>
          <td style="text-align:right"><span class="num-link clickable" data-reqid="${escapeHtml(reqId)}" data-reqname="${escapeHtml(reqName)}" data-counttype="total">${total}</span><span class="progress-ctr"><span class="progress-fill" style="width:${totalPct}%;"></span></span></td>
          <td style="text-align:right"><span class="num-link clickable" data-reqid="${escapeHtml(reqId)}" data-reqname="${escapeHtml(reqName)}" data-counttype="added">${added}</span><span class="progress-ctr"><span class="progress-fill" style="width:${addedPct}%;"></span></span></td>
          <td style="text-align:right"><span class="num-link clickable" data-reqid="${escapeHtml(reqId)}" data-reqname="${escapeHtml(reqName)}" data-counttype="not_rejected">${notRejected}</span></td>
          <td style="text-align:right"><span class="num-link clickable" data-reqid="${escapeHtml(reqId)}" data-reqname="${escapeHtml(reqName)}" data-counttype="r2">${r2}</span></td>
          <td style="text-align:right"><span class="num-link clickable" data-reqid="${escapeHtml(reqId)}" data-reqname="${escapeHtml(reqName)}" data-counttype="r3">${r3}</span></td>
          <td style="text-align:right"><span class="num-link clickable" data-reqid="${escapeHtml(reqId)}" data-reqname="${escapeHtml(reqName)}" data-counttype="hr">${hr}</span></td>
          <td style="text-align:right"><span class="num-link clickable" data-reqid="${escapeHtml(reqId)}" data-reqname="${escapeHtml(reqName)}" data-counttype="offered">${offered}</span></td>
        </tr>`;
      });

      html+=`</tbody></table></div>`; // close table wrap
      // append pagination after table
      html += buildPaginationChips(page, Math.max(1, Math.ceil(rows.length/pageSize)));
      win.document.getElementById('popup-content').innerHTML = html;
      
  // insert summary after table HTML so it is not overwritten
  try{ renderSummary(rows); }catch(e){console.error('renderSummary failed',e);} 
win.document.getElementById('results-count').textContent = `${rows.length} results`;
      attachHandlers(rows);
    }

    // Handlers
    function attachHandlers(allRows){
      Array.from(win.document.querySelectorAll('.num-link.clickable')).forEach(a=>{
        a.onclick=function(e){ e.preventDefault(); const reqId=a.getAttribute('data-reqid'); const reqName=a.getAttribute('data-reqname'); const countType=a.getAttribute('data-counttype'); openCandidatesListInPopup(win,reqId,reqName,countType); };
      });

      Array.from(win.document.querySelectorAll('.chip')).forEach(chip=>{
        chip.onclick=function(){
          const cur=Array.from(win.document.querySelectorAll('.chip'));
          cur.forEach(c=>c.classList.remove('active'));
          chip.classList.add('active');
          const filtered=applyFiltersAndSearch(win._allRows||[], chip.getAttribute('data-filter'));
          renderTable(filtered,1,Number(win.document.getElementById('page-size').value||100));
        };
      });

      const searchEl = win.document.getElementById('popup-search');
      if(searchEl){
        let tmr=null;
        searchEl.oninput=function(){ clearTimeout(tmr); tmr=setTimeout(()=>{ const filtered=applyFiltersAndSearch(win._allRows||[], null); renderTable(filtered,1,Number(win.document.getElementById('page-size').value||100)); },250); };
      }

      const pageSizeEl = win.document.getElementById('page-size');
      if(pageSizeEl){ pageSizeEl.onchange=function(){ const filtered=applyFiltersAndSearch(win._allRows||[], null); renderTable(filtered,1,Number(this.value||100)); }; }

      const sortEl = win.document.getElementById('popup-sort');
      if(sortEl){ sortEl.onchange=function(){ const filtered=applyFiltersAndSearch(win._allRows||[], null); renderTable(filtered,1,Number(win.document.getElementById('page-size').value||100)); }; }

      Array.from(win.document.querySelectorAll('.page-chip')).forEach(c=>{ c.onclick=function(){ const p=Number(c.getAttribute('data-page')||1); const filtered=applyFiltersAndSearch(win._allRows||[], null); renderTable(filtered,p,Number(win.document.getElementById('page-size').value||100)); }; });

      const exportBtn = win.document.getElementById('export-csv');
      if(exportBtn){ exportBtn.onclick=function(){ const filtered=applyFiltersAndSearch(win._allRows||[], null); const csv=rowsToCSV(filtered); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=win.document.createElement('a'); a.href=url; a.download=`requirements_${(clientName||'all').replace(/\s+/g,'_')}.csv`; win.document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }; }

      const copyBtn = win.document.getElementById('copy-clip');
      if(copyBtn){ copyBtn.onclick=async function(){ const filtered=applyFiltersAndSearch(win._allRows||[], null); const tsv=filtered.map(r=>[r.client_name||'', r.requirement_name||'', r.client_poc||'', r.assigned_to||'', r.total_candidates||0, r.candidates_last_7_days||0, r.candidates_not_rejected||0].join('\t')).join('\n'); try{ await navigator.clipboard.writeText(tsv); alert('Copied to clipboard'); }catch(err){ const w=win.open('','_blank','width=600,height=400'); w.document.body.innerText=tsv; } }; }
    }

    function applyFiltersAndSearch(rows, overrideFilter){
    // ----- Summary Renderer -----
    

      let out = rows.slice();
      const filter = overrideFilter || (win.document.querySelector('.chip.active') && win.document.querySelector('.chip.active').getAttribute('data-filter')) || 'all';
      if(filter === 'active') out = out.filter(r => Number(r.total_candidates||0) > 0);
      else if(filter === 'gt10') out = out.filter(r => Number(r.total_candidates||0) > 10);
      else if(filter === '7d'){ const cutoff = Date.now() - (7*24*60*60*1000); out = out.filter(r => { const t = getReqTimestamp(r); return t && t >= cutoff; }); }
      else if(filter === 'less5_nr'){ out = out.filter(r => Number(r.candidates_not_rejected || r.candidates_not_rejected_count || 0) < 5); }
      else if(filter === 'no_added_4d'){ out = out.filter(r => { const added4 = Number(r.candidates_last_4_days || r.candidates_added_last_4_days || r.candidates_last_7_days || 0); return added4 === 0; }); }
      else if(filter === 'unassigned_reqs'){ out = out.filter(r => { const assigned = (r.assigned_to || r.assigned || '').toString().trim(); return assigned.length === 0; }); }
      const q = (win.document.getElementById('popup-search') && win.document.getElementById('popup-search').value || '').toLowerCase().trim();
      if(q) out = out.filter(r => ((r.requirement_name||'') + ' ' + (r.client_name||'') + ' ' + (r.assigned_to||'') + ' ' + (r.client_poc||'')).toLowerCase().includes(q));
      const sel = win.document.getElementById('popup-sort');
      if(sel){ const v = sel.value || 'date_desc'; if(v === 'client_name_asc') out.sort((a,b)=> (a.client_name||'').localeCompare(b.client_name||'')); else if(v === 'client_name_desc') out.sort((a,b)=> (b.client_name||'').localeCompare(a.client_name||'')); else out.sort((a,b)=> getReqTimestamp(b) - getReqTimestamp(a)); }
      return out;
    }

    try{
      const page=1;
      const perPage=1000;
      const url = clientName === 'All Clients'
        ? `/api/client/requirements_details_all?page=${page}&per_page=${perPage}`
        : `/api/client/requirements_details?client_name=${encodeURIComponent(clientName)}&page=${page}&per_page=${perPage}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('Failed to fetch requirements');
      const data = await res.json();
      if(!data.requirements){ win.document.getElementById('popup-content').innerHTML = '<div class="small-muted">No active requirements found.</div>'; return; }
      win._allRows = data.requirements || [];
      // default active chip
      const chipAll = win.document.querySelector('.chip[data-filter="all"]');
      if(chipAll){ Array.from(win.document.querySelectorAll('.chip')).forEach(c=>c.classList.remove('active')); chipAll.classList.add('active'); }
      const filtered = applyFiltersAndSearch(win._allRows, 'all');
      renderTable(filtered, 1, Number(win.document.getElementById('page-size').value || 100));
    }catch(err){
      win.document.getElementById('popup-content').innerHTML = `<div style="color:#c00">Failed to load: ${escapeHtml(err.message||'')}</div>`;
      console.error(err);
    }
  }






  // Fetch and render candidates inside the provided popup window. Adds a Back button
  // to restore the requirements table stored earlier on win._requirementsRows
  async function openCandidatesListInPopup(win, requirementId, requirementName, countType) {
    if (!win) return;
    try {

    const candStyle = `
      /* Candidate-popup scoped styles */
      .cand-popup { padding:0; margin:0; font-family: Inter, system-ui, Arial, sans-serif; color:var(--navy); }
      .cand-popup .table-wrap { overflow:auto; padding:0; background:transparent; border:none; }
      .cand-popup table { width:100%; min-width:900px; table-layout:auto; border-collapse:collapse; }
      .cand-popup thead th { position:sticky; top:0; z-index:20; white-space:nowrap; writing-mode:horizontal-tb; transform:none; padding:10px 12px; text-align:left; background:linear-gradient(90deg,var(--navy),#1e293b); color:#fff; }
      .cand-popup tbody td { white-space:normal; word-break:break-word; padding:10px 12px; }
      .cand-popup thead th.pinned, .cand-popup td.pinned { position:sticky; left:0; z-index:21; background:linear-gradient(90deg,var(--navy),#1e293b); }
      /* ensure header labels stay horizontal and do not wrap */
      .cand-popup thead th { line-height:1.2; }
      /* remove any progress bars styling conflicts */
      .cand-popup .progress-ctr { display:none; }
    `;

      win.document.getElementById('popup-content').innerHTML = '<div class="muted">Loading candidatesâ€¦</div>';

      // fetch candidate list (basic fields)
      const page = 1; // Start with first page
      const perPage = 100; // Default page size
      
      let url = `/api/candidates?requirement_id=${encodeURIComponent(requirementId)}`;
      if (countType) url += `&count_type=${encodeURIComponent(countType)}`;
      url += `&page=${page}&per_page=${perPage}`;
      
      const listRes = await fetch(url);
      if (!listRes.ok) throw new Error('Failed to fetch candidates');
      const data = await listRes.json();
      const candidateDetails = data.data || [];

      // Store pagination info
      win._candidateCurrentPage = data.pagination.page;
      win._candidateTotalPages = data.pagination.pages;
      win._candidatePerPage = data.pagination.per_page;
      win._requirementId = requirementId;
      win._requirementName = requirementName;
      win._countType = countType;

      // Build candidates table with pagination controls
      let html = `
        <div><h2 style="display:inline-block;margin-left:12px;font-size:16px;">Candidates for: ${escapeHtml(requirementName || requirementId)}</h2></div>`;
      
      // Add pagination controls
      html += addCandidatePaginationControls(data.pagination);
      
      html += '<div class="popup-table-wrapper"><table><thead><tr>'
        + '<th>Name</th>'
        + '<th>Email</th>'
        + '<th>Phone</th>'
        + '<th>Company</th>'
        + '<th>Location</th>'
        + '<th>CTC (Current)</th>'
        + '<th>ECTC (Expected)</th>'
        + '<th>Notice Period</th>'
        + '<th>Profile Status</th>'
        + '<th>Calling Status</th>'
        + '<th>Offer Details</th>'
        + '<th>Comments</th>'
        + '<th>Added By</th>'
        + '<th>Added Date</th>'
        + '</tr></thead><tbody>';

      candidateDetails.forEach(c => {
        const name = c.candidate_name || c.name || c.full_name || '';
        const email = (c.emails && (Array.isArray(c.emails) ? c.emails.join(', ') : c.emails)) || c.email || '';
        const phone = (c.phones && (Array.isArray(c.phones) ? c.phones.join(', ') : c.phones)) || c.phone || '';
        const company = c.company || c.current_company || c.employer || '';
        const location = c.location || c.current_location || '';
        const ctc = c.current_ctc || c.ctc || c.current_salary || '';
        const ectc = c.expected_ctc || c.ectc || c.expected_salary || '';
        const notice = c.notice_period || c.notice || '';
        const profileStatus = c.profile_status || c.status || '';
        const callingStatus = c.calling_status || c.calling || '';
        const offerDetails = c.offer_details || c.offer || '';
        const comments = c.comments || c.notes || '';
        const addedBy = c.added_by || c.added_by_name || c.created_by || '';
        const addedDate = c.added_date || c.created_at || c.added_on || '';

        html += '<tr>'
          + `<td>${escapeHtml(name)}</td>`
          + `<td>${escapeHtml(email)}</td>`
          + `<td>${escapeHtml(phone)}</td>`
          + `<td>${escapeHtml(company)}</td>`
          + `<td>${escapeHtml(location)}</td>`
          + `<td>${escapeHtml(ctc)}</td>`
          + `<td>${escapeHtml(ectc)}</td>`
          + `<td>${escapeHtml(notice)}</td>`
          + `<td>${escapeHtml(profileStatus)}</td>`
          + `<td>${escapeHtml(callingStatus)}</td>`
          + `<td>${escapeHtml(offerDetails)}</td>`
          + `<td>${escapeHtml(comments)}</td>`
          + `<td>${escapeHtml(addedBy)}</td>`
          + `<td>${escapeHtml(addedDate)}</td>`
          + '</tr>';
      });

      html += '</tbody></table></div>';
      win.document.getElementById('popup-content').innerHTML = `<style>${candStyle}</style><div class="cand-popup">` + html + `</div>`;

      // Add event listener for pagination buttons
      const prevBtn = win.document.querySelector('.candidate-pagination .prev-btn');
      const nextBtn = win.document.querySelector('.candidate-pagination .next-btn');
      
      if (prevBtn) {
        prevBtn.onclick = () => loadCandidatePage(win, data.pagination.page - 1);
      }
      if (nextBtn) {
        nextBtn.onclick = () => loadCandidatePage(win, data.pagination.page + 1);
      }

      // Hook up Back button â€” inline (duplicated) requirements-rendering logic (no call to openRequirementsPopup)
      const backBtn = win.document.getElementById('back-to-reqs');
      if (backBtn) {
        backBtn.addEventListener('click', async function (e) {
          e.preventDefault();

          // Use the client name stored on the popup window
          const clientName = win._clientName || '';

          // set a safe title element (use textContent to avoid XSS)
          try {

    

            if (!win.document.head) {
              const head = win.document.createElement('head');
              win.document.documentElement.insertBefore(head, win.document.body);
            }
            const existingTitle = win.document.head.querySelector('title');
            if (existingTitle) existingTitle.remove();
            const titleEl = win.document.createElement('title');
            titleEl.textContent = `Requirements â€” ${clientName}`;
            win.document.head.appendChild(titleEl);
          } catch (err) {
            console.error('Failed to set popup title', err);
          }

          const popupContent = win.document.getElementById('popup-content');
          if (popupContent) popupContent.innerHTML = '<div class="muted">Loadingâ€¦</div>';

          try {

    

            const page = win._currentPage || 1;
            const perPage = win._perPage || 100;
            
            let url = clientName === 'All Clients' 
              ? `/api/client/requirements_details_all?page=${page}&per_page=${perPage}`
              : `/api/client/requirements_details?client_name=${encodeURIComponent(clientName)}&page=${page}&per_page=${perPage}`;
            
            const reqRes = await fetch(url);
            if (!reqRes.ok) throw new Error('Failed to fetch requirements');
            const data = await reqRes.json();
            const rows = data.requirements || [];

            if (!rows.length) {
              if (popupContent) popupContent.innerHTML = '<div class="muted">No active requirements found for this client.</div>';
              return;
            }

            win._requirementsRows = rows;
            win._clientName = clientName;
            win._currentPage = data.pagination.page;
            win._totalPages = data.pagination.pages;
            win._perPage = data.pagination.per_page;

            const escape = (typeof escapeHtml === 'function') ? escapeHtml : (win.opener && win.opener.escapeHtml) ? win.opener.escapeHtml : (s => String(s || '').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[ch])));

            let htmlReq = '<div style="margin-bottom:8px;" class="muted">Click any candidate count to view the candidate list for that requirement (opens below in same window).</div>';
            htmlReq += addPaginationControls(data.pagination);
            htmlReq += '<div class="popup-table-wrapper"><table><thead><tr>'
              + '<th>Client Name</th>'
              + '<th>Requirement Name</th>'
              + '<th>Client POC</th>'
              + '<th>Assigned To</th>'
              + '<th style="text-align:right">Total Candidates</th>'
              + '<th style="text-align:right">Added (7d)</th>'
              + '<th style="text-align:right">Not Rejected</th>'
              + '<th style="text-align:right">R2 Candidates</th>'
              + '<th style="text-align:right">R3 Candidates</th>'
              + '<th style="text-align:right">HR Rounds</th>'
              + '<th style="text-align:right">Offered</th>'
              + '</tr></thead><tbody>';

            rows.forEach(r => {
              const reqName = r.requirement_name || '';
              const client = r.client_name || win._clientName || '';
              const clientPoc = r.client_poc || '';
              const assigned = r.assigned_to || '';
              const reqId = r.requirement_id || r.requirement || '';
              const totalCandidates = Number(r.total_candidates || 0);
              const added7 = Number(r.candidates_last_7_days || 0);
              const notRejected = Number(r.candidates_not_rejected || 0);
              const r2Candidates = Number(r.r2_candidates || 0);
              const r3Candidates = Number(r.r3_candidates || 0);
              const hrRounds = Number(r.hr_rounds || 0);
              const offered = Number(r.offered_count || 0);

              htmlReq += '<tr>'
                + `<td>${escape(client)}</td>`
                + `<td>${escape(reqName)}</td>`
                + `<td>${escape(clientPoc)}</td>`
                + `<td>${escape(assigned)}</td>`
                + `<td style="text-align:right"><a href="#" class="count-link" data-reqid="${escape(reqId)}" data-reqname="${escape(reqName)}" data-counttype="total">${totalCandidates}</a></td>`
                + `<td style="text-align:right"><a href="#" class="count-link" data-reqid="${escape(reqId)}" data-reqname="${escape(reqName)}" data-counttype="added">${added7}</a></td>`
                + `<td style="text-align:right"><a href="#" class="count-link" data-reqid="${escape(reqId)}" data-reqname="${escape(reqName)}" data-counttype="not_rejected">${notRejected}</a></td>`
                + `<td style="text-align:right"><a href="#" class="count-link" data-reqid="${escape(reqId)}" data-reqname="${escape(reqName)}" data-counttype="r2">${r2Candidates}</a></td>`
                + `<td style="text-align:right"><a href="#" class="count-link" data-reqid="${escape(reqId)}" data-reqname="${escape(reqName)}" data-counttype="r3">${r3Candidates}</a></td>`
                + `<td style="text-align:right"><a href="#" class="count-link" data-reqid="${escape(reqId)}" data-reqname="${escape(reqName)}" data-counttype="hr">${hrRounds}</a></td>`
                + `<td style="text-align:right"><a href="#" class="count-link" data-reqid="${escape(reqId)}" data-reqname="${escape(reqName)}" data-counttype="offered">${offered}</a></td>`
                + '</tr>';
            });

            htmlReq += '</tbody></table></div>';

            if (popupContent) popupContent.innerHTML = `<style>` + candStyle + `</style><div class="cand-popup">` + htmlReq + `</div>`;

            if (win._popupClickHandler && typeof win._popupClickHandler === 'function') {
              try {

    
 win.document.removeEventListener('click', win._popupClickHandler); } catch (er) { /* ignore */ }
            }

            win._popupClickHandler = function popupClickHandler(e) {
              const tgt = (e.target && e.target.closest) ? e.target : (e.target && e.target.parentElement) ? e.target.parentElement : e.target;
              const a = tgt && tgt.closest && tgt.closest('.count-link');
              if (!a) return;
              e.preventDefault();
              const reqId = a.getAttribute('data-reqid');
              const reqName = a.getAttribute('data-reqname');
              const countType = a.getAttribute('data-counttype') || a.getAttribute('data-count-Type') || (a.dataset && a.dataset.counttype);
              const openerFn = (typeof openCandidatesListInPopup === 'function') ? openCandidatesListInPopup : (win.opener && typeof win.opener.openCandidatesListInPopup === 'function') ? win.opener.openCandidatesListInPopup : null;
              if (openerFn) {
                openerFn(win, reqId, reqName, countType);
              } else {
                console.error('openCandidatesListInPopup function is not available to popup.');
              }
            };

            win.document.addEventListener('click', win._popupClickHandler);

          } catch (err) {
            if (popupContent) popupContent.innerHTML = `<div style="color:#c00">Failed to load data: ${escape(err.message || '')}</div>`;
            console.error(err);
          }
        });
      }

    } catch (err) {
      win.document.getElementById('popup-content').innerHTML = `<div style="color:#c00">Failed to load data: ${escapeHtml(err.message || '')}</div>`;
      console.error(err);
    }
  }

  loadClients();
});
</script>

{% endblock %}